#!/usr/bin/env bash

set -e

LEIN_PREFER=""
LEIN_VER=""
LEIN_VER1_PATTERN="^Leiningen\ 1\."
BIN=$(cd `dirname $0`; pwd)

command_exists () {
  type "$1" &>/dev/null
}

download_lein () {
  "$BIN/get_lein.js"
  chmod +x "$BIN/lein"
  echo "$BIN/lein"
}

if command_exists lein2; then
  LEIN_PREFER=lein2
elif command_exists lein; then
  LEIN_PREFER=lein
elif [ ! -x "$LEIN_PREFER" ]; then
  LEIN_PREFER="$BIN/lein"
fi

if [ -x "$LEIN_PREFER" ]; then
  LEIN_VER=$("$LEIN_PREFER" version)
fi

if [[ ! -x "$LEIN_PREFER" || "$LEIN_VER" =~ "$LEIN_VER1_PATTERN" ]]; then
  >&2 echo "Leiningen v2 not found, downloading..."
  >&2 download_lein
fi

if [ ! -x "$LEIN_PREFER" ]; then
  echo "Failed to find or set up Leiningen"
  exit 1
fi

"$LEIN_PREFER" $@
